import{_ as i,c as a,o as n,ag as l}from"./chunks/framework.DPDPlp3K.js";const g=JSON.parse('{"title":"SQL 性能调优专题","description":"","frontmatter":{},"headers":[],"relativePath":"sql/performance.md","filePath":"sql/performance.md","lastUpdated":1747206212000}'),h={name:"sql/performance.md"};function e(p,s,t,k,r,d){return n(),a("div",null,s[0]||(s[0]=[l(`<h1 id="sql-性能调优专题" tabindex="-1">SQL 性能调优专题 <a class="header-anchor" href="#sql-性能调优专题" aria-label="Permalink to &quot;SQL 性能调优专题&quot;">​</a></h1><h2 id="_1-性能调优总览与常见瓶颈" tabindex="-1">1. 性能调优总览与常见瓶颈 <a class="header-anchor" href="#_1-性能调优总览与常见瓶颈" aria-label="Permalink to &quot;1. 性能调优总览与常见瓶颈&quot;">​</a></h2><ul><li>常见瓶颈：全表扫描、索引未命中、慢查询、锁等待、网络延迟、硬件资源不足</li><li>优化思路：优先分析 SQL 执行计划，定位慢点，逐步优化</li></ul><h2 id="_2-索引优化" tabindex="-1">2. 索引优化 <a class="header-anchor" href="#_2-索引优化" aria-label="Permalink to &quot;2. 索引优化&quot;">​</a></h2><ul><li>合理选择主键、唯一索引、联合索引</li><li>常用类型：B-Tree、Hash、GIN、GiST（PostgreSQL）</li><li>WHERE、JOIN、ORDER BY、GROUP BY 字段优先考虑加索引</li><li>避免在频繁变更字段、低基数字段上建索引</li><li>注意索引覆盖与冗余，定期清理无用索引</li></ul><h2 id="_3-查询优化" tabindex="-1">3. 查询优化 <a class="header-anchor" href="#_3-查询优化" aria-label="Permalink to &quot;3. 查询优化&quot;">​</a></h2><ul><li>使用 EXPLAIN/EXPLAIN ANALYZE 分析执行计划</li><li>避免 SELECT *，明确字段名</li><li>WHERE 条件写法影响索引命中（如函数包裹、隐式转换）</li><li>优化 JOIN 顺序，减少嵌套子查询</li><li>合理拆分/合并 SQL，减少网络往返</li></ul><h2 id="_4-批量与分页优化" tabindex="-1">4. 批量与分页优化 <a class="header-anchor" href="#_4-批量与分页优化" aria-label="Permalink to &quot;4. 批量与分页优化&quot;">​</a></h2><ul><li>批量插入/更新建议分批处理，减少单次数据量</li><li>大数据分页优先用 keyset/游标分页，避免 OFFSET 大量跳过</li><li>示例：</li></ul><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- keyset 分页</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $lastId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ASC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_5-事务与并发控制优化" tabindex="-1">5. 事务与并发控制优化 <a class="header-anchor" href="#_5-事务与并发控制优化" aria-label="Permalink to &quot;5. 事务与并发控制优化&quot;">​</a></h2><ul><li>事务范围尽量小，减少锁持有时间</li><li>合理选择隔离级别，避免不必要的串行化</li><li>捕获死锁异常并重试</li><li>读多写少场景可用只读副本分担压力</li></ul><h2 id="_6-数据库参数与硬件优化" tabindex="-1">6. 数据库参数与硬件优化 <a class="header-anchor" href="#_6-数据库参数与硬件优化" aria-label="Permalink to &quot;6. 数据库参数与硬件优化&quot;">​</a></h2><ul><li>合理配置连接池、缓存、内存、磁盘 IO</li><li>定期监控慢查询、锁等待、资源利用率</li><li>SSD 替代机械硬盘提升 IO 性能</li><li>分库分表/分区表应对超大数据量</li></ul><h2 id="_7-典型代码片段-含-jsdoc-注释" tabindex="-1">7. 典型代码片段（含 JSDoc 注释） <a class="header-anchor" href="#_7-典型代码片段-含-jsdoc-注释" aria-label="Permalink to &quot;7. 典型代码片段（含 JSDoc 注释）&quot;">​</a></h2><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 使用 EXPLAIN 分析 SQL 执行计划</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {import(&#39;pg&#39;).Pool}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {string}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - 需分析的 SQL</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@returns</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {Promise&lt;Array&gt;}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 执行计划</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> explainQuery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rows</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;EXPLAIN &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Keyset 分页查询</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {import(&#39;pg&#39;).Pool}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {number}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastId</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {number}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@returns</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {Promise&lt;Array&gt;}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 订单列表</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getOrdersByKeyset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lastId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;SELECT * FROM orders WHERE id &gt; $1 ORDER BY id ASC LIMIT $2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rows</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql, [lastId, limit]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_8-性能调优工具推荐" tabindex="-1">8. 性能调优工具推荐 <a class="header-anchor" href="#_8-性能调优工具推荐" aria-label="Permalink to &quot;8. 性能调优工具推荐&quot;">​</a></h2><ul><li><a href="https://explain.depesz.com/" target="_blank" rel="noreferrer">explain.depesz.com</a>（PostgreSQL 执行计划分析）</li><li><a href="https://www.percona.com/software/database-tools/percona-toolkit" target="_blank" rel="noreferrer">pt-query-digest</a>（MySQL 慢查询分析）</li><li><a href="https://github.com/dalibo/pgbadger" target="_blank" rel="noreferrer">pgBadger</a>（PostgreSQL 日志分析）</li><li>数据库自带监控与慢查询日志</li></ul><hr><p>性能调优是持续过程，建议定期分析、监控与总结，团队协作提升整体数据服务能力。</p>`,20)]))}const o=i(h,[["render",e]]);export{g as __pageData,o as default};
